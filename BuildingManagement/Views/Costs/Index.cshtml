@model BuildingManagement.ViewModels.CostsIndexData

@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

@using (Html.BeginForm("Index", "Costs", FormMethod.Get))
{
    <div class="form-horizontal">
        <h4>Costs</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            @Html.LabelFor(model => model.DiscountMonth, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.DiscountMonth, new { htmlAttributes = new { @id = "DiscountMonth", @class = "form-control", onchange = "GetInvoices()" } })
                @Html.ValidationMessageFor(model => model.DiscountMonth, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Client, "ClientID", htmlAttributes: new {@class = "control-label col-md-2"})
            <div class="col-md-10">
                @Html.DropDownList("ClientID", null, "Select...", htmlAttributes: new {@class = "form-control", onchange = "GetSections(this.value, null)" })
                @Html.ValidationMessageFor(model => model.ClientID, "", new {@class = "text-danger"})
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Section, "SectionID", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownList("SectionID", null, "Select...", htmlAttributes: new { @class = "form-control", onchange = "GetInvoices()" })
                @Html.ValidationMessageFor(model => model.SectionID, "", new { @class = "text-danger" })
            </div>
        </div>
    </div>
}

<script src="~/Scripts/jquery-1.10.2.js"></script>

<script>
    $(document).ready(function() {
        var minDate = (new Date('0001-01-01')).toUTCString();
        var discountMonth = new Date(document.getElementById("DiscountMonth").value).toUTCString();
        if (discountMonth === minDate) {
            document.getElementById("DiscountMonth").value = "";
        }
    });

    function GetSections(idClient, idSection) {
        var sectionList = $("#SectionID");
        sectionList.empty();
        var firstSection = new Option("Select...", "0");
        sectionList.append(firstSection);

        var url = "../Costs/GetSectionsByClient/";
        
        $.ajax({
            url: url,
            data: { clientId: idClient, sectionId: idSection },
            cache: false,
            type: "POST",
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    var item = new Option(data[i].Text, data[i].Value, false, data[i].Selected);
                    sectionList.append(item);
                }
            },
            error: function (reponse) {
                alert("error : " + reponse);
            }
        });
    }

    function GetInvoices() {
        var discountMonth = document.getElementById("DiscountMonth").value;
        var clientId = document.getElementById("ClientID").value;
        var providerId = document.getElementById("ProviderID").value;
        window.location.href = "/InvoiceDistribution/Index/?discountMonth=" + discountMonth + "&clientId=" + clientId + "&providerId=" + providerId;
    }
</script>
